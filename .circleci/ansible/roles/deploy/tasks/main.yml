---
# - name: "create backend app directory"
#   file:
#     path: ~/backend-app
#     state: directory
# - name: "Move backend files to server."
#   copy:
#     src: artifact.tar.gz
#     dest: ~/home/ubuntu

# - name: "unarchive backend files"
#   unarchive:
#     src: artifact.tar.gz
#     dest: ~/backend-app

# - name: "install node dependancies"
#   shell: |
#     cd ~/backend-app/dist
#     pm2 stop default
#     pm2 start main.js
  
#   register: execute_node

# - name: "print message"
#   debug:
#     msg: "{{ execute_node.stdout_lines }}"

# - name: "configure pm2 to start as service"
#   become: true
#   shell: | 
#     env PATH=$PATH:/usr/local/bin pm2 startup systemd -u ubuntu --hp /home/ubuntu

- name: "Move backend files to server."
  copy:
    src: /root/project/backend_artifact.tar.gz
    dest: ~/home/ubuntu

- name: "install package dependencies"
  shell: |
    cd ~/home/ubuntu
    tar -xzvf backend_artifact.tar.gz -C backend
    rm backend_artifact.tar.gz
    cd backend/
    # npm install && npm run build
    npm audit fix && npm run build
    cd dist
    echo `pwd` >> ansible-test.txt
    pm2 start npm --name backend -- start